name: Security Scans (GHAS Alternative)

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'
  schedule:
    # Scan diário às 2h UTC
    #- cron: '0 2 * * *'

permissions:
  contents: read
  actions: read
  security-events: write
  pull-requests: write

jobs:
  security-scans:
    name: Security Analysis Suite
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Histórico completo para análise

      # ============================================
      # SAST (Static Application Security Testing)
      # ============================================
      
      - name: Setup Semgrep (SAST)
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install semgrep==1.95.0
          semgrep --version

      - name: Semgrep SAST Scan (Pro Rules)
        run: |
          mkdir -p security-reports
          # p/security-audit: regras de segurança abrangentes
          # p/owasp-top-ten: OWASP Top 10
          # p/cwe-top-25: CWE Top 25
          semgrep scan \
            --config p/security-audit \
            --config p/owasp-top-ten \
            --config p/cwe-top-25 \
            --config p/ci \
            --severity ERROR \
            --severity WARNING \
            --sarif -o security-reports/semgrep.sarif \
            --json -o security-reports/semgrep.json || true
        continue-on-error: true

      # ============================================
      # CodeQL Alternative - Melhor análise SAST
      # ============================================
      
      - name: Setup Sonar Scanner CLI
        run: |
          wget -q https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
          unzip -q sonar-scanner-cli-5.0.1.3006-linux.zip
          echo "$PWD/sonar-scanner-5.0.1.3006-linux/bin" >> $GITHUB_PATH

      - name: SonarQube Scan (Local Analysis)
        run: |
          mkdir -p security-reports
          # Análise local sem servidor (modo standalone)
          sonar-scanner \
            -Dsonar.projectKey=${{ github.repository }} \
            -Dsonar.sources=. \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.organization=${{ github.repository_owner }} \
            -Dsonar.login=${{ secrets.SONAR_TOKEN }} \
            -Dsonar.qualitygate.wait=true || echo "SonarQube requer configuração - continuando..."
        continue-on-error: true
        if: env.SONAR_TOKEN != ''

      # ============================================
      # SCA (Software Composition Analysis)
      # ============================================
      
      - name: Setup Trivy
        uses: aquasecurity/setup-trivy@v0.2.4
        with:
          version: v0.58.1
          cache: true

      - name: Trivy SCA - Vulnerabilities & Licenses
        run: |
          mkdir -p security-reports
          trivy fs . \
            --scanners vuln,license,misconfig \
            --severity CRITICAL,HIGH,MEDIUM \
            --format sarif \
            --output security-reports/trivy-sca.sarif
          
          # JSON detalhado para análise
          trivy fs . \
            --scanners vuln,license \
            --severity CRITICAL,HIGH,MEDIUM \
            --format json \
            --output security-reports/trivy-sca.json || true
        continue-on-error: true

      - name: Setup OWASP Dependency-Check
        run: |
          VERSION=10.0.4
          wget -q https://github.com/jeremylong/DependencyCheck/releases/download/v${VERSION}/dependency-check-${VERSION}-release.zip
          unzip -q dependency-check-${VERSION}-release.zip
          echo "$PWD/dependency-check/bin" >> $GITHUB_PATH

      - name: OWASP Dependency-Check Scan
        run: |
          mkdir -p security-reports
          dependency-check.sh \
            --scan . \
            --format SARIF \
            --out security-reports \
            --suppression .dependency-check-suppression.xml \
            --enableExperimental \
            --nvdApiKey ${{ secrets.NVD_API_KEY }} || true
          
          # Renomear relatório
          [ -f security-reports/dependency-check-report.sarif ] && \
            mv security-reports/dependency-check-report.sarif security-reports/dependency-check.sarif || true
        continue-on-error: true
        env:
          NVD_API_KEY: ${{ secrets.NVD_API_KEY }}

      # ============================================
      # Secrets Detection
      # ============================================
      
      - name: Install Gitleaks
        run: |
          VERSION=8.21.2
          curl -sSL https://github.com/gitleaks/gitleaks/releases/download/v${VERSION}/gitleaks_${VERSION}_linux_x64.tar.gz \
            | tar xz -C /usr/local/bin gitleaks
          gitleaks version

      - name: Gitleaks Secret Scan
        run: |
          mkdir -p security-reports
          if [ -f .gitleaks.toml ]; then
            gitleaks detect \
              --source . \
              --config .gitleaks.toml \
              --report-format sarif \
              --report-path security-reports/gitleaks.sarif \
              --verbose \
              --redact || true
          else
            gitleaks detect \
              --source . \
              --report-format sarif \
              --report-path security-reports/gitleaks.sarif \
              --verbose \
              --redact || true
          fi
          
          # JSON para métricas
          gitleaks detect --source . --report-format json \
            --report-path security-reports/gitleaks.json --redact || true
        continue-on-error: true

      - name: TruffleHog Secret Scan
        run: |
          # Instalação do TruffleHog
          curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh | sh -s -- -b /usr/local/bin
          
          mkdir -p security-reports
          trufflehog filesystem . \
            --json \
            --no-update > security-reports/trufflehog.json || true
        continue-on-error: true

      # ============================================
      # IaC Security
      # ============================================
      
      - name: Trivy IaC Scan
        run: |
          mkdir -p security-reports
          trivy config . \
            --severity CRITICAL,HIGH,MEDIUM \
            --format sarif \
            --output security-reports/trivy-iac.sarif
          
          trivy config . \
            --severity CRITICAL,HIGH,MEDIUM \
            --format json \
            --output security-reports/trivy-iac.json || true
        continue-on-error: true

      - name: Checkov IaC Scan
        run: |
          pip install checkov==3.2.255
          mkdir -p security-reports
          
          checkov --directory . \
            --framework all \
            --output sarif \
            --soft-fail \
            --output-file-path security-reports \
            --output-filename checkov.sarif || true
        continue-on-error: true

      - name: KICS IaC Scan
        run: |
          docker run --rm \
            -v $PWD:/path \
            checkmarx/kics:latest scan \
            --path /path \
            --output-path /path/security-reports \
            --output-name kics \
            --report-formats sarif,json \
            --exclude-severities info \
            --no-progress || true
        continue-on-error: true

      # ============================================
      # Container Security
      # ============================================
      
      - name: Trivy Container Image Scan
        run: |
          mkdir -p security-reports
          # Scan de imagens Docker se houver Dockerfile
          if [ -f Dockerfile ]; then
            docker build -t local-image:latest .
            trivy image \
              --severity CRITICAL,HIGH,MEDIUM \
              --format sarif \
              --output security-reports/trivy-container.sarif \
              local-image:latest || true
          fi
        continue-on-error: true

      - name: Grype Container Scan
        run: |
          # Instalar Grype (alternativa ao Trivy)
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin
          
          mkdir -p security-reports
          if [ -f Dockerfile ]; then
            grype dir:. \
              --output sarif \
              --file security-reports/grype.sarif || true
          fi
        continue-on-error: true

      # ============================================
      # Code Quality & Complexity
      # ============================================
      
      - name: Lizard Complexity Analysis
        run: |
          pip install lizard
          mkdir -p security-reports
          lizard . -o security-reports/lizard.txt || true
        continue-on-error: true

      # ============================================
      # Upload SARIF Reports to GitHub Security
      # ============================================
      
      - name: Upload Semgrep SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: security-reports/semgrep.sarif
          category: semgrep-sast
        continue-on-error: true

      - name: Upload Trivy SCA SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: security-reports/trivy-sca.sarif
          category: trivy-sca
        continue-on-error: true

      - name: Upload Dependency-Check SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: security-reports/dependency-check.sarif
          category: owasp-dependency-check
        continue-on-error: true

      - name: Upload Gitleaks SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: security-reports/gitleaks.sarif
          category: gitleaks-secrets
        continue-on-error: true

      - name: Upload Trivy IaC SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: security-reports/trivy-iac.sarif
          category: trivy-iac
        continue-on-error: true

      - name: Upload Checkov SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: security-reports/results_checkov.sarif
          category: checkov-iac
        continue-on-error: true

      - name: Upload KICS SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: security-reports/kics.sarif
          category: kics-iac
        continue-on-error: true

      - name: Upload Trivy Container SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: security-reports/trivy-container.sarif
          category: trivy-container
        continue-on-error: true

      - name: Upload Grype SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: security-reports/grype.sarif
          category: grype-container
        continue-on-error: true

      # ============================================
      # Artifacts & Reports
      # ============================================
      
      - name: Upload All Security Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports-${{ github.sha }}
          path: security-reports/
          retention-days: 90

      # ============================================
      # Security Summary (PR Comment)
      # ============================================
      
      - name: Generate Security Summary
        if: always() && github.event_name == 'pull_request'
        run: |
          cat > security-reports/summary.md << 'EOF'
          ## Security Scan Results
          
          ### Scans Executados:
          - ✅ **SAST**: Semgrep (security-audit, OWASP Top 10, CWE Top 25)
          - ✅ **SCA**: Trivy + OWASP Dependency-Check
          - ✅ **Secrets**: Gitleaks + TruffleHog
          - ✅ **IaC**: Trivy + Checkov + KICS
          - ✅ **Container**: Trivy + Grype
          - ✅ **Code Quality**: Lizard
          
          ### Resultados:
          Verifique a aba **Security** para detalhes completos dos alertas encontrados.
          
          Relatórios detalhados disponíveis nos artifacts deste workflow.
          EOF
          
          cat security-reports/summary.md
        continue-on-error: true

      - name: Comment PR with Summary
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('security-reports/summary.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
        continue-on-error: true
